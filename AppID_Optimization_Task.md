# Context
Filename: AppID_Optimization_Task.md
Created On: 2024-12-19
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
用户建议修改 type 字段传递 appid（Bundle ID），让后端根据 group: 'app' 判断并从 appid 中打开文件，而不是使用当前的应用名称映射方式。

# Project Overview
这是一个 Flutter macOS 应用，包含 Finder 扩展功能。当前实现使用应用名称到 Bundle ID 的映射，用户建议直接传递 Bundle ID 来简化后端逻辑并提高准确性。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
## 当前实现分析
1. **前端 Flutter 代码**：
   - `FinderMenuItem` 模型包含 `title`、`type`、`enabled`、`group` 字段
   - 默认菜单项使用固定 type 值：`openMainApplication`、`openInVSCode`、`openInWarp`
   - 动态添加的菜单项使用格式：`openWithApp:${appController.text}`
   - 在 `_showAddMenuItemDialog` 中，用户选择应用后只保存应用名称

2. **后端 Swift 代码**：
   - `FinderActionHandler.swift` 中的 `performOpenWithApp` 方法
   - 硬编码的应用名称到 Bundle ID 映射表
   - 需要维护 switch 语句来处理不同的应用类型

3. **问题识别**：
   - 应用名称可能存在歧义或本地化问题
   - 后端需要维护映射表，增加维护成本
   - 无法处理用户自定义应用的 Bundle ID

# Proposed Solution (Populated by INNOVATE mode)
## 解决方案设计

### 方案选择：直接使用 Bundle ID 作为 type 值
对于 `group: 'app'` 的菜单项，将 `type` 字段直接设置为应用的 Bundle ID，而不是应用名称。

### 优势分析
1. **精确性**：Bundle ID 是系统级唯一标识符，避免歧义
2. **简化后端**：无需维护应用名称到 Bundle ID 的映射表
3. **扩展性**：支持任意第三方应用，只需获取其 Bundle ID
4. **一致性**：所有 app 类型菜单项使用统一的数据格式

### 实现策略
1. **前端改动**：
   - 修改默认菜单项的 type 值为对应的 Bundle ID
   - 修改应用选择逻辑，获取并保存 Bundle ID 而非应用名称
   - 保持向后兼容性，处理旧格式数据

2. **后端改动**：
   - 简化 `performOpenWithApp` 方法
   - 对于 `group: 'app'` 的项目，直接使用 type 作为 Bundle ID
   - 移除硬编码的映射逻辑

# Implementation Plan (Generated by PLAN mode)

## 变更计划

### 文件1：lib/ui/home_page.dart
- **原因**：更新默认菜单项的 type 值为 Bundle ID，修改应用选择逻辑
- **具体变更**：
  1. 将默认 app 类型菜单项的 type 改为对应的 Bundle ID
  2. 修改 `_showAddMenuItemDialog` 中的应用选择逻辑，获取 Bundle ID
  3. 添加向后兼容性处理

### 文件2：macos/Handlers/FinderActionHandler.swift
- **原因**：简化后端处理逻辑，直接使用 Bundle ID
- **具体变更**：
  1. 修改 `performOpenWithApp` 方法
  2. 对于 app 组的菜单项，直接使用 type 作为 Bundle ID
  3. 移除硬编码的应用名称映射

### 文件3：native/folder_picker.dart
- **原因**：可能需要添加获取应用 Bundle ID 的原生方法
- **具体变更**：检查是否需要新增获取 Bundle ID 的方法

## Implementation Checklist:
1. 修改 home_page.dart 中的默认菜单项，将 app 类型的 type 值改为对应的 Bundle ID
2. 修改 _showAddMenuItemDialog 方法，在用户选择应用时获取并保存 Bundle ID
3. 添加向后兼容性处理，确保旧格式的菜单项仍能正常工作
4. 修改 FinderActionHandler.swift 中的 performOpenWithApp 方法，简化 Bundle ID 处理逻辑
5. 测试新实现，确保所有 app 类型菜单项正常工作
6. 更新相关注释和文档

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> Currently executing: "URL Scheme 重构优化"

✅ **步骤 5 完成** (2024-12-19): 移除旧格式支持
- 修改内容：移除 URLSchemeHandler.swift 中对旧格式菜单项的向后兼容支持
- 具体变更：
  - 删除了 "openInTerminal", "openInVSCode", "openInWarp", "openWithApp" 等旧格式的处理逻辑
  - 简化了 switch 语句，只保留 Bundle ID 格式和文件创建相关操作
  - 代码更加简洁，逻辑更加清晰
- 测试结果：构建成功，无编译错误
- 影响：完全移除了对旧格式的支持，确保系统只使用新的 Bundle ID 格式

✅ **步骤 6 完成** (2024-12-19): URL Scheme 重构优化
- **问题背景**: 用户反馈直接将 Bundle ID 作为 type 参数不合理，建议根据 group 分类，用另外的参数指定具体应用
- **文件修改**: 
  - `URLSchemeHandler.swift`: 重构 switch 语句，添加 "app" case 处理应用打开请求
  - `ActionDispatcher.swift`: 修改 `sendAppAction` 方法签名和实现
  - `FinderSync.swift`: 更新 `handleAppAction` 方法调用
- **URL Scheme 格式变更**:
  - **旧格式**: `dishapp://action?type=com.microsoft.VSCode&path=...`
  - **新格式**: `dishapp://action?type=app&bundleId=com.microsoft.VSCode&path=...`
- **主要改进**:
  - ✅ **语义清晰**: type 参数现在表示操作类型（app、copyPath、createNewFile 等）
  - ✅ **参数分离**: Bundle ID 通过专门的 bundleId 参数传递
  - ✅ **扩展性**: 便于后续添加其他类型的操作
  - ✅ **一致性**: 所有操作都遵循相同的 URL 格式规范
- **构建结果**: ✅ 应用构建成功
- **影响**: 提高了 URL Scheme 的可读性和可维护性，使参数语义更加清晰

# Task Progress (Appended by EXECUTE mode after each step completion)
✅ **步骤1完成**: 修改 home_page.dart 中的默认菜单项，将 app 类型的 type 值改为对应的 Bundle ID
   - 将 'openMainApplication' 改为 'com.dish.main'
   - 将 'openInVSCode' 改为 'com.microsoft.VSCode'
   - 将 'openInTerminal' 改为 'com.apple.Terminal'
   - 将 'openInWarp' 改为 'dev.warp.Warp-Stable'

✅ **步骤2完成**: 修改应用选择逻辑，获取并保存 Bundle ID
   - 更新 MenuConfigHandler.swift 的 pickApplication 方法，返回包含 Bundle ID 的字典
   - 更新 folder_picker.dart 的 pickApplication 方法，处理新的返回格式
   - 修改 home_page.dart 中的应用选择逻辑，使用 Bundle ID 作为 type 值
   - 更新 UI 标签和提示文本，显示 Bundle ID 而非应用名称

✅ **步骤3完成**: 添加向后兼容性处理
   - 更新自定义菜单项识别逻辑，支持新的 Bundle ID 格式
   - 在 URLSchemeHandler.swift 中添加对旧格式的兼容处理

✅ **步骤4完成**: 修改后端处理逻辑
   - 简化 FinderActionHandler.swift 中的 performOpenWithApp 方法
   - 移除硬编码的应用名称到 Bundle ID 映射
   - 直接使用传入的 appType 作为 Bundle ID 查找应用
   - 更新终端应用检测逻辑，基于 Bundle ID 判断

# Final Review (Populated by REVIEW mode)

## 实现总结
✅ **任务成功完成**：已将 FinderMenuItem 的 type 字段改为直接传递 Bundle ID，实现了更精确的应用识别和简化的后端逻辑。

## 主要变更
1. **前端 Flutter 代码**：
   - 默认菜单项使用 Bundle ID：`com.dish.main`、`com.microsoft.VSCode`、`com.apple.Terminal`、`dev.warp.Warp-Stable`
   - 应用选择器返回包含 Bundle ID 的完整信息
   - UI 更新为显示 Bundle ID 输入
   - 自定义菜单项识别逻辑支持新格式

2. **后端 Swift 代码**：
   - 简化了 `performOpenWithApp` 方法，直接使用 Bundle ID 查找应用
   - 移除了硬编码的应用名称映射表
   - 添加了向后兼容性支持
   - 优化了终端应用检测逻辑

## 优势实现
- ✅ **精确性**：Bundle ID 是系统级唯一标识符，避免了应用名称歧义
- ✅ **简化后端**：无需维护复杂的映射表，代码更简洁
- ✅ **扩展性**：支持任意第三方应用，只需获取其 Bundle ID
- ✅ **向后兼容**：保持对旧格式菜单项的支持
- ✅ **一致性**：所有 app 类型菜单项使用统一的数据格式

## 测试结果
- ✅ 代码编译成功，无语法错误
- ✅ Flutter 应用成功启动
- ✅ 所有修改的文件都已正确更新

## 建议后续测试
1. 测试默认菜单项（VSCode、Terminal、Warp）的打开功能
2. 测试自定义应用的添加和使用
3. 验证向后兼容性（如果有旧格式的菜单项）
4. 测试 Finder 扩展中的菜单项调用